# DECISIONS

- Payments are first-class: invoices can have multiple payments (partial payments supported).
- Invoice status is derived from payments; overpaid invoices use `CREDIT` status (PENDING/PARTIAL/PAID/CREDIT via `InvoiceStatus` enum).
- DAL is the only layer touching SQLAlchemy `Session`; services orchestrate DAL and apply business rules.
- Primary keys for School/Student/Invoice/Payment use UUIDv7; all related foreign keys are UUID.
- DAL create/update inputs use TypedDict payloads (not many function params).
- Auth is demo-basic JWT with a role claim (admin). No user table unless required.
- Auth transport uses HTTP Bearer tokens with JSON login (`POST /auth/login`) to keep smoke tests and local usage simple (no OAuth form flow).
- Admin credentials are env-configured (`ADMIN_USERNAME`, `ADMIN_PASSWORD`), with demo defaults and warning logs when insecure defaults are used.
- Observability is free/simple: structured logs, `/health`, `/health/db`, `/metrics`.
- Database migrations are manual local/dev operations via Alembic CLI wrappers (`db-upgrade`, `db-revision`) and never auto-run on app import/startup.
- Seed data is intentionally idempotent-ish using stable demo natural keys (school/student names, invoice attributes, payment references) so `db-seed` is safe to run repeatedly.
- API smoke tests for HTTP routes use HTTPX `AsyncClient` + `ASGITransport` (not `TestClient`) for Python 3.13 compatibility; DB access is mocked via dependency override.
- 404 handling uses a custom `NotFoundError` with a global exception handler; routers raise `NotFoundError` instead of `HTTPException` for missing resources.
- Pagination defaults are centralized (offset/limit/max) in `app/api/constants.py`.
- DAL update inputs use TypedDict payloads (app/dal/update_types.py) derived from model_dump(exclude_unset=True).
- CI quality gates run in GitHub Actions on push/PR to `main` with Python 3.12 only (`ruff`, `mypy`, `pytest -m smoke`).
- Integration tests are opt-in (`pytest -m integration`) and use a dedicated `TEST_DATABASE_URL` (never `DATABASE_URL` by default); they skip unless the URL is reachable, local-hosted, and explicitly test-named to prevent destructive TRUNCATE on non-test databases.
- Domain-level errors (`DomainError`, `NotFoundError`, `ConflictError`) are the cross-layer error contract; FastAPI maps them to HTTP in one global handler module.
- Services depend on repo ports (`Protocol`) and DTOs, while SQLAlchemy implementations live in DAL adapters (`app/dal/repos/*`).
- Statement generation and invoice-payments listing are explicit use-cases wired through FastAPI dependencies for testability without DB access.
- DB-backed FastAPI path handlers must be synchronous (`def`) when using sync SQLAlchemy repositories/services; keep `async def` only for non-blocking endpoints (e.g., in-memory health/metrics).
